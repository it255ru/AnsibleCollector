FROM debian:bullseye

ARG VERSION
ENV VERSION=$VERSION \
    container=docker

# Установка пакетов
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        systemd systemd-sysv openssh-server sudo iproute2 python3 && \
    ln -sf /usr/bin/python3 /usr/bin/python && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Настройка SSH с генерацией пароля
RUN mkdir -p /var/run/sshd && \
    PASSWORD=$(head -c 12 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9') && \
    echo "root:$PASSWORD" | chpasswd && \
    echo "Generated password: $PASSWORD" > /password.txt && \
    chmod 600 /etc/shadow /etc/passwd /password.txt && \
    sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd && \
    systemctl enable ssh

# Оптимизация для systemd
RUN rm -f /lib/systemd/system/multi-user.target.wants/getty.target && \
    systemctl mask dev-hugepages.mount sys-fs-fuse-connections.mount

VOLUME ["/sys/fs/cgroup", "/run", "/run/lock"]
STOPSIGNAL SIGTERM
EXPOSE 22
CMD ["/lib/systemd/systemd"]
